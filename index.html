<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Live TfL Bus & Tube Board</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#8b5cf6">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-512.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1220; --grad-a:#1b0f2e; --grad-b:#0f1220;
      --card:rgba(23,26,46,.92); --muted:#8a91b4; --text:#f3f5ff;
      --accent:#8b5cf6; --accent-2:#a78bfa; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#22d3ee;
      --card-border:rgba(255,255,255,.08); --chip-text:#111; --chip-shadow:rgba(0,0,0,.28); --table-shadow:rgba(0,0,0,.35);
      --line-268:#fb7185; --line-13:#fde047; --line-460:#60a5fa; --line-102:#34d399; --line-210:#f472b6;
      --tag:#101327;
    }
    [data-theme="light"]{
      --bg:#faf7ff; --grad-a:#ede9fe; --grad-b:#f5d0fe;
      --card:rgba(255,255,255,.94); --muted:#5b5f7a; --text:#0f1220;
      --accent:#7c3aed; --accent-2:#c084fc; --good:#16a34a; --warn:#d97706; --bad:#b91c1c; --info:#0891b2;
      --card-border:rgba(17,17,17,.10); --chip-text:#111; --chip-shadow:rgba(0,0,0,.14); --table-shadow:rgba(0,0,0,.12);
      --tag:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1100px 600px at 80% -10%, var(--grad-a) 0%, rgba(27,31,56,0) 60%),
        radial-gradient(1200px 800px at -10% -30%, var(--accent) 0%, rgba(30,27,75,0) 60%),
        linear-gradient(135deg, var(--grad-a), var(--grad-b));
    }
    .wrap{width:100%; max-width:1180px; margin:18px auto 28px; padding:0 12px}

    /* header */
    header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    .title-row{display:flex;flex-direction:column;gap:4px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .clock{font-weight:900}
    .actions-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    /* iOS-style toggle (COMPACT) */
    .switch{
      --w: 24px;      /* width */
      --h: 14px;      /* height */
      --pad: 2px;
      --thumb: calc(var(--h) - var(--pad)*2);
      position: relative;
      width: var(--w);
      height: var(--h);
    }
    .switch input{ position:absolute; opacity:0; inset:0; }
    .switch .track{
      width:100%; height:100%;
      background:#9ca3af; border-radius:999px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,.3);
      transition: background .18s ease; display:block;
    }
    .switch .thumb{
      position:absolute; top:var(--pad); left:var(--pad);
      width:var(--thumb); height:var(--thumb);
      border-radius:50%; background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.35);
      transition:left .18s ease;
    }
    .switch input:checked + .track{ background:#8b5cf6; }
    .switch input:checked + .track + .thumb{
      left: calc(var(--w) - var(--pad) - var(--thumb));
    }

    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--card-border);background:transparent;color:var(--text);cursor:pointer;font-weight:800;letter-spacing:.2px}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));border:0;color:#111}

    @media (min-width:860px){
      header{display:grid;grid-template-columns:1fr auto auto;grid-template-areas:"title . actions";align-items:center}
      .title-row{grid-area:title}
      .actions-row{grid-area:actions;justify-self:end}
    }

    .card{background:var(--card);border:1px solid var(--card-border);box-shadow:0 14px 34px var(--table-shadow);backdrop-filter:blur(8px);border-radius:16px;margin-bottom:14px}
    .tabs{display:flex;gap:8px;padding:10px}
    .tab{flex:1;text-align:center;padding:14px 10px;border-radius:12px;cursor:pointer;color:var(--muted);
      background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(0,0,0,.04));border:1px solid var(--card-border);font-weight:900}
    .tab.active{color:#111;background:linear-gradient(135deg,#e9d5ff,#a7f3d0);border:0}

    .table-container{padding:8px 10px 2px;overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%}
    table{width:100%;min-width:820px;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);padding:14px 12px;text-align:left}
    tbody tr{background:var(--card);border:1px solid var(--card-border);box-shadow:0 8px 24px var(--table-shadow)}
    tbody tr[data-clickable="1"]{cursor:pointer}
    tbody tr.selected{outline:2px solid var(--accent-2)}
    tbody td{padding:16px 12px;font-size:15px}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}

    .chip{--c:#888;background:var(--c);color:var(--chip-text);display:inline-flex;align-items:center;justify-content:center;min-width:56px;height:30px;padding:0 12px;border-radius:9px;font-weight:900;box-shadow:inset 0 -3px rgba(0,0,0,.15),0 6px 16px rgba(0,0,0,.25)}
    .line-268{--c:var(--line-268)} .line-13{--c:var(--line-13)} .line-460{--c:var(--line-460)} .line-102{--c:var(--line-102)} .line-210{--c:var(--line-210)}
    .stopLetter{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#d80f2f;color:#fff;font-weight:900;border:none;box-shadow:0 2px 6px rgba(0,0,0,.25)}

    .skeleton{height:14px;width:70px;border-radius:6px;background:linear-gradient(90deg,#1f243e,#2b3053,#1f243e);background-size:200% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .meta{display:flex;justify-content:space-between;gap:12px;padding:14px;color:var(--muted);font-size:12px;flex-wrap:wrap}
    .muted{color:var(--muted)}

    /* ===== Tracker (renamed to avoid .track clash) ===== */
    .tracker-card{background:var(--card);border:1px solid var(--card-border);box-shadow:0 14px 34px var(--table-shadow);border-radius:16px;margin-bottom:14px}
    .tracker-head{font-size:16px;margin:0;padding:12px;border-bottom:1px solid var(--card-border);display:flex;justify-content:space-between;align-items:center}
    .tracker-meta{padding:10px 12px;color:var(--muted);font-size:13px}
    .track-wrap{position:relative;margin:10px;padding:14px;border:1px dashed var(--card-border);border-radius:12px;background:var(--tag);overflow-x:auto;overflow-y:visible}
    .route-track{ /* <— was .track */
      position:relative;height:28px;min-width:520px;display:flex;align-items:center;gap:36px;padding:0 6px
    }
    .stop-dot{position:relative;width:14px;height:14px;border-radius:999px;background:#6b7280;flex:0 0 14px}
    .stop-dot.past{background:var(--good)} .stop-dot.next{background:var(--warn)} .stop-dot.dest{box-shadow:0 0 0 3px rgba(255,255,255,.18)}
    .stop-dot::after{content:'';position:absolute;top:6px;left:14px;width:36px;height:2px;background:rgba(255,255,255,.18)}
    .stop-dot:last-child::after{display:none}
    .tt{position:absolute;left:50%;bottom:140%;transform:translate(-50%,0) scale(.98);white-space:nowrap;background:#0b0f25;border:1px solid var(--card-border);padding:6px 8px;border-radius:8px;color:#fff;font-size:12px;opacity:0;visibility:hidden;transition:all .12s;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:5}
    .stop-dot:hover .tt{opacity:1;visibility:visible;transform:translate(-50%,-10px) scale(1)}
    .link{position:absolute;top:6px;left:14px;width:36px;height:2px;background:rgba(255,255,255,.18)}
    .link.past{background:linear-gradient(90deg,var(--good),var(--good))}
    .link.next{background:linear-gradient(90deg,var(--warn),var(--warn))}
    .bus-dot{position:absolute;top:-4px;width:26px;height:26px;transform:translateX(-13px);display:grid;place-items:center;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35))}
    .bus-dot svg{width:26px;height:26px}
    .lock-badge{margin-left:8px;font-size:12px;color:#111;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:2px 8px;border-radius:999px;font-weight:800}
    .pad{border:1px solid var(--card-border); background:transparent; color:var(--text); border-radius:8px; padding:6px 8px; margin-left:8px; cursor:pointer}

    .status{display:flex;flex-wrap:wrap;gap:8px;padding:10px}
    .pill{display:inline-flex;gap:8px;align-items:center;background:var(--tag);border:1px solid var(--card-border);padding:10px 12px;border-radius:12px}
    .dot{width:10px;height:10px;border-radius:999px}
    .sev-good{background:var(--good)} .sev-warn{background:var(--warn)} .sev-bad{background:var(--bad)} .sev-info{background:var(--info)}
    .toast{position:fixed;right:14px;bottom:14px;background:#11152c;border:1px solid var(--card-border);color:var(--text);padding:10px 12px;border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(8px);transition:all .2s;z-index:99}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title-row">
        <h1>Live TfL Bus & Tube Board</h1>
        <div class="clock" id="clock">--:--</div>
        <div class="sub">Buses • Northern line • Service status • auto-refresh 30s (10s when locked)</div>
      </div>
      <div class="actions-row">
        <label class="switch" title="Toggle theme">
          <input id="themeToggle" type="checkbox" />
          <span class="track"></span><span class="thumb"></span>
        </label>
        <button class="btn primary" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <section class="card">
      <div class="tabs">
        <div class="tab active" data-view="morning">Morning</div>
        <div class="tab" data-view="afternoon">Afternoon</div>
        <div class="tab" data-view="status">Service Status</div>
      </div>

      <div class="table-container" id="viewBody"></div>

      <div class="meta">
        <div>Last updated: <span id="lastUpdated">never</span></div>
        <div>Sources: TfL Unified API (buses)</div>
      </div>
    </section>

    <!-- Tracker -->
    <section class="tracker-card" id="trackerCard" style="display:none">
      <h2 class="tracker-head">
        Tracking <span id="lockBadge" class="lock-badge" style="display:none">Locked</span>
        <button id="unlockBtn" class="pad" style="display:none" title="Unlock">🔓 Unlock</button>
      </h2>
      <div class="tracker-meta" id="trackMeta">—</div>
      <div class="track-wrap"><div class="route-track" id="trackBar"></div></div>
      <div class="tracker-meta" id="trackFooter">—</div>
    </section>
  </div>

  <div id="toast" class="toast">Pinned!</div>

  <script>
    /* ==== Theme & clock ==== */
    const root=document.documentElement, toggle=document.getElementById('themeToggle');
    function applyTheme(t){ root.setAttribute('data-theme',t); localStorage.setItem('tfl_theme',t); toggle.checked = (t==='light'); }
    applyTheme(localStorage.getItem('tfl_theme')||'dark');
    toggle.addEventListener('change',()=> applyTheme(toggle.checked?'light':'dark'));
    function tick(){const d=new Date();clock.textContent=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
    setInterval(tick,30000); tick();

    /* ==== TfL helpers ==== */
    const APP_ID="", APP_KEY="";
    const qs=o=>new URLSearchParams({...o,...((APP_ID&&APP_KEY)?{app_id:APP_ID,app_key:APP_KEY}:{})}).toString();
    const tfl=async url=>{const r=await fetch(url); if(!r.ok) throw new Error('TfL'); return r.json();};
    const arrivalsAt=(id,m)=>tfl(`https://api.tfl.gov.uk/StopPoint/${encodeURIComponent(id)}/Arrivals?${qs({modes:m})}`);
    const searchStopPoints=(q,m)=>tfl(`https://api.tfl.gov.uk/StopPoint/Search?${qs({query:q,modes:m,types:'NaptanPublicBusCoachTram'})}`);
    const getStopPoint=id=>tfl(`https://api.tfl.gov.uk/StopPoint/${id}?${qs({})}`);
    async function resolveChildByLetter(place,letter){
      const res=await searchStopPoints(place,'bus'); const L=String(letter||'').toUpperCase(); const all=[];
      for(const m of (res.matches||[])){ all.push(m); try{ const d=await getStopPoint(m.id); (d.children||[]).forEach(c=>all.push(c)); }catch{} }
      const hit=all.find(i=>(i.additionalProperties||[]).some(p=>p.key==='StopLetter' && (p.value||'').toUpperCase()===L));
      return hit?.id||null;
    }
    function matchByLine(rows,line){const w=String(line).toUpperCase().trim();return rows.filter(r=>{const id=String(r.lineId||'').toUpperCase().trim(); const nm=String(r.lineName||'').toUpperCase().trim(); return id===w||nm===w||id.startsWith(w)||nm.startsWith(w);});}
    const minsUntil=ts=>Math.max(0,Math.round((new Date(ts)-new Date())/60000));
    function fmtAbs(m){const when=new Date(Date.now()+Math.max(0,m)*60000); return `${String(when.getHours()).padStart(2,'0')}:${String(when.getMinutes()).padStart(2,'0')}`;}
    const fmtCell=m=> m<=0 ? 'Due' : `${fmtAbs(m)} (${m}m)`;

    /* ==== ETA smoothing ==== */
    const etaCache = new Map(); // key -> last mins
    function smooth(key,mins){
      if(mins==null) return null;
      const prev=etaCache.get(key);
      if(prev==null){ etaCache.set(key,mins); return mins; }
      const maxJump=5;
      if(Math.abs(mins-prev)>maxJump) mins = prev + Math.sign(mins-prev)*maxJump;
      const a=0.6; const sm=Math.round(a*mins+(1-a)*prev);
      etaCache.set(key,sm); return sm;
    }

    /* ==== Data (your stops) ==== */
    const routesConfig={
      morning:[
        {line:"268", origin:"Haverstock Hill", destination:"Golders Green Bus Station", stopLetter:"H",  stopId:"490003874H"},
        {line:"268", origin:"Rosslyn Hill",   destination:"Golders Green Bus Station", stopLetter:"G",  stopId:"490015255G"},
        {line:"210", origin:"Brent Cross Tesco", destination:"Golders Green Bus Station", stopLetter:"T",  stopId:"490004284T"},
        {line:"102", origin:"Claremont Way",  destination:"Golders Green Bus Station", stopLetter:"A",  stopId:"490005434S"},
        {line:"SL10", origin:"Hendon Central Station", destination:"North Finchley Bus Station", stopLetter:"A",  stopId:"490000106A"},
        {line:"13",  origin:"Golders Green",  destination:"North Finchley Bus Station", stopLetter:"GU", stopId:"490015496GU"},
        {line:"460", origin:"Golders Green",  destination:"North Finchley Bus Station", stopLetter:"GU", stopId:"490015496GU"},
      ],
      afternoon:[
        {line:"460", origin:"North Finchley Bus Station", destination:"Golders Green Bus Station", stopLetter:"P",  stopId:"490015443P"},
        {line:"13",  origin:"North Finchley Bus Station", destination:"Golders Green Bus Station", stopLetter:"P",  stopId:"490015443P"},
        {line:"SL10", origin:"North Finchley Bus Station", destination:"Hendon Central", stopLetter:"H", stopId:"490010369H"},
        {line:"268", origin:"Golders Green", destination:"Pond Street / Royal Free", stopLetter:"GJ", stopId:"490000087GJ"},
        {line:"102", origin:"Golders Green Station", destination:"Claremont Way", stopLetter:"GV", stopId:"490015496GV"},
        {line:"210", origin:"Golders Green", destination:"Brent Cross Underground", stopLetter:"GK", stopId:"490000087GK"},
      ]
    };

    /* ==== Tracker state (kept simple) ==== */
    const trackerCard=document.getElementById('trackerCard'),
          trackMeta=document.getElementById('trackMeta'),
          trackBar=document.getElementById('trackBar'),
          trackFooter=document.getElementById('trackFooter'),
          lockBadge=document.getElementById('lockBadge'),
          unlockBtn=document.getElementById('unlockBtn'),
          toast=document.getElementById('toast');

    let currentView='morning', selectedIndex=null, selectedItem=null, selectedVehicleId=null, isLocked=false, lockTicker=null;

    const BUS_SVG=`<svg viewBox="0 0 32 32" role="img" aria-label="Bus"><rect x="2" y="8" width="28" height="12" rx="3" ry="3" fill="#e11d48"/><rect x="4" y="10" width="10" height="5" rx="2" ry="2" fill="white" opacity=".9"/><rect x="16" y="10" width="10" height="5" rx="2" ry="2" fill="white" opacity=".9"/><circle cx="9" cy="22" r="3" fill="#0b0b0b"/><circle cx="23" cy="22" r="3" fill="#0b0b0b"/></svg>`;
    const showToast=msg=>{toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200);};

    /* ==== UI rendering ==== */
    const viewBody=document.getElementById('viewBody');
    const tabs=[...document.querySelectorAll('.tab')];
    tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); currentView=t.dataset.view; render(); attachHandlers(); refresh();});

    const lineClass=line=>`line-${line.replace(/\D/g,'')}`;
    function renderBusTable(which){
      const rows=routesConfig[which];
      const head=`<thead><tr>
        <th>Board</th><th>Origin</th><th>Destination</th><th>Line</th>
        <th style="text-align:right">Arrives</th><th style="text-align:right">Vehicle</th>
      </tr></thead>`;
      const body=rows.map((r,i)=>`
        <tr data-clickable="1" data-idx="${i}">
          <td><span class="stopLetter" title="${r.stopLetter}">${r.stopLetter}</span></td>
          <td>${r.origin}</td>
          <td>${r.destination}</td>
          <td><span class="chip ${lineClass(r.line)}">${r.line}</span></td>
          <td style="text-align:right"><span class="arrive" id="bus-${which}-${i}"><span class="skeleton"></span></span></td>
          <td style="text-align:right"><span class="veh" id="veh-${which}-${i}">—</span></td>
        </tr>`).join('');
      return `<table>${head}<tbody>${body}</tbody></table>`;
    }
    function renderStatus(){ return `<div class="status"><div class="pill"><span class="dot sev-info"></span><strong>Live</strong><span class="muted" style="margin-left:6px">Running</span></div></div>`; }

    function render(){
      if(currentView==='morning'||currentView==='afternoon'){ viewBody.innerHTML=renderBusTable(currentView); }
      else { viewBody.innerHTML=renderStatus(); trackerCard.style.display='none'; }
    }

    function attachHandlers(){
      if(currentView==='morning'||currentView==='afternoon'){
        [...document.querySelectorAll('tbody tr[data-clickable="1"]')].forEach((tr,i)=> tr.onclick=()=>selectRow(i));
      }
    }

    /* ==== Bus updates (always writes a time) ==== */
    function soonestMins(items){
      items.sort((a,b)=>new Date(a.expectedArrival)-new Date(b.expectedArrival));
      if(!items.length) return null;
      return minsUntil(items[0].expectedArrival);
    }

    async function updateBus(which){
      const rows=routesConfig[which];
      await Promise.all(rows.map(async (r,i)=>{
        const etaEl=document.getElementById(`bus-${which}-${i}`);
        const vehEl=document.getElementById(`veh-${which}-${i}`);
        try{
          let sid=r.stopId || await resolveChildByLetter(r.origin,r.stopLetter);
          if(!sid){ etaEl.textContent='—'; etaEl.style.color='var(--muted)'; vehEl.textContent='—'; return; }
          r.stopId=sid;

          const data=await arrivalsAt(sid,'bus');
          const match=matchByLine(data,r.line).sort((a,b)=>new Date(a.expectedArrival)-new Date(b.expectedArrival));
          const vid=match[0]?.vehicleId||null;
          vehEl.textContent=vid?vid:'—';

          let mins=soonestMins(match);
          mins = smooth(`${which}:${i}`, mins);

          if(mins==null){
            etaEl.textContent='—';
            etaEl.style.color='var(--muted)';
            etaEl.removeAttribute('title');
          }else{
            etaEl.textContent = fmtCell(mins);
            etaEl.title = fmtCell(mins);
            etaEl.style.color = mins<=2 ? 'var(--good)' : (mins<=8 ? 'var(--warn)' : 'var(--text)');
          }
        }catch{
          etaEl.textContent='—'; etaEl.style.color='var(--muted)'; vehEl.textContent='—';
        }
      }));
      lastUpdated.textContent=new Date().toLocaleTimeString();
    }

    async function refresh(){
      if(currentView==='morning') await updateBus('morning');
      else if(currentView==='afternoon') await updateBus('afternoon');
      else {/* status only */}
    }

    /* ==== Tracker (optional click) ==== */
    async function selectRow(i){
      selectedIndex=i; const r=routesConfig[currentView][i];
      trackMeta.textContent=`${r.origin} (${r.stopLetter}) → ${r.destination} — ${r.line}`;
      trackerCard.style.display='';
      trackBar.innerHTML='';
      // simple visual cue only (no heavy route work here to keep it snappy)
      const dot=document.createElement('div'); dot.className='stop-dot next'; dot.innerHTML=`<div class="tt"><strong>${r.origin}</strong></div>`;
      trackBar.appendChild(dot);
      let bus=trackBar.querySelector('.bus-dot'); if(!bus){ bus=document.createElement('div'); bus.className='bus-dot'; bus.innerHTML=BUS_SVG; trackBar.appendChild(bus); }
      bus.style.left=`6px`;
      trackFooter.textContent=`Tracking ${r.line} towards ${r.destination}`;
      showToast('Tracking row');
    }

    /* ==== Boot ==== */
    function init(){ render(); attachHandlers(); refresh(); }
    init();
    refreshBtn.onclick=refresh;
    setInterval(refresh,30000);

    // Service worker (optional)
    if('serviceWorker' in navigator){ addEventListener('load',()=>navigator.serviceWorker.register('service-worker.js')); }
  </script>
</body>
</html>

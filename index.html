<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>SchoolRun â€” Live Board</title>

<style>
  @font-face{font-family:"Uber Move";src:local("Uber Move"),local("UberMove-Regular");font-weight:400;font-style:normal;font-display:swap}
  @font-face{font-family:"Uber Move";src:local("Uber Move Bold"),local("UberMove-Bold");font-weight:700;font-style:normal;font-display:swap}
</style>

<style>
  :root{
    --bg:#000; --panel:#0a0a0a; --card:#111; --text:#fff; --muted:#a3a3a3;
    --border:#1f1f1f; --pill:#171717; --shadow:0 10px 20px rgba(0,0,0,.35);
    --good:#22c55e; --warn:#f59e0b;
    --chip-bg:#1a1a1a; --chip-text:#fff;

    --stop-badge:#d80f2f; --stop-text:#ffffff;

    --gutter:10px;
    --arrow:#a855f7;
    --tab-bg:#eef2f71c; --tab-bg-strong:#e5e7eb33;

    --toggle-track:#e5e7eb33; --toggle-knob:#fff; --toggle-icon:#111;

    /* Tube map */
    --tube-line:#9ca3af;  /* dotted spine */
    --tube-dot:#a855f7;   /* purple dots */
    --tube-card:#111; --tube-dest:#fff;
  }
  body.light{
    --bg:#fff; --panel:#ffffff; --card:#fff; --text:#111; --muted:#575757;
    --border:#e5e7eb; --pill:#f4f5f6; --shadow:0 8px 18px rgba(0,0,0,.12);
    --chip-bg:#f4f5f6; --chip-text:#111;

    --stop-badge:#d80f2f; --stop-text:#ffffff;

    --arrow:#7c3aed;
    --tab-bg:#eef2f7; --tab-bg-strong:#e4e9f1;

    --toggle-track:#e5e7eb; --toggle-knob:#111; --toggle-icon:#fff;

    --tube-line:#cbd5e1; --tube-dot:#7c3aed;
    --tube-card:#fff; --tube-dest:#111;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:"Uber Move",-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"Helvetica Neue",Arial,Inter,system-ui,sans-serif;
    letter-spacing:.01em;
  }

  .wrap{width:100%; max-width:none; margin:0; padding:0 var(--gutter) 18px}

  /* Header */
  .topbar{
    position:sticky; top:0; z-index:40;
    display:flex; align-items:center; justify-content:space-between;
    padding:10px var(--gutter); background:var(--panel); border-bottom:1px solid var(--border); gap:10px;
  }
  .brand-stack{ display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
  .brand-row{ display:flex; align-items:center; gap:10px; }
  .logo-img{height:48px;width:auto;display:block}
  .appname{font-weight:700;font-size:18px}

  .menu{ display:flex; gap:8px; }
  .tabbtn{
    width:46px; height:46px; display:grid; place-items:center;
    border-radius:12px; border:1px solid var(--border);
    background:var(--tab-bg); color:var(--arrow); cursor:pointer;
  }
  .tabbtn:hover{ background:var(--tab-bg-strong); }
  .tabbtn.active{ background:var(--tab-bg); border-color:var(--border); }
  .icon{ font-size:22px; line-height:1; user-select:none; display:inline-block; }
  @keyframes blinkIcon { 0%,49%{opacity:1} 50%,100%{opacity:.25} }
  .tabbtn.active .icon{ animation:blinkIcon 1s infinite }

  /* Theme toggle */
  .theme-ctl{ display:flex; align-items:center; gap:10px; }
  .toggle{
    position:relative; width:74px; height:34px; border-radius:999px; padding:4px;
    background:var(--toggle-track); border:1px solid var(--border);
    display:flex; align-items:center; cursor:pointer; user-select:none;
  }
  .toggle input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
  .knob{
    width:26px; height:26px; border-radius:999px; background:var(--toggle-knob);
    display:grid; place-items:center; color:var(--toggle-icon);
    font-size:14px; font-weight:900; transform:translateX(0); transition:transform .2s ease;
    box-shadow:0 2px 6px rgba(0,0,0,.25); z-index:1;
  }
  .toggle input:checked ~ .knob{ transform:translateX(40px); }
  .mark{ position:absolute; top:50%; transform:translateY(-50%); font-size:12px; opacity:.9; z-index:0; }
  .mark.sun{ left:12px } .mark.moon{ right:12px }

  /* Bus card */
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); overflow:visible; }
  .table-container{ padding:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; overscroll-behavior-x:contain; touch-action:pan-x; }
  table{ width:100%; min-width:880px; border-collapse:separate; border-spacing:0 6px; table-layout:fixed; }
  thead th{ font-size:11px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); padding:10px 10px; text-align:left }
  tbody tr{ background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow) }
  tbody td{ padding:10px 10px; font-size:15px; vertical-align:top }
  tbody tr td:first-child{border-radius:12px 0 0 12px}
  tbody tr td:last-child{border-radius:0 12px 12px 0}
  .ell{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  .stopLetter{
    display:inline-flex;align-items:center;justify-content:center;
    width:28px;height:28px;border-radius:50%;
    background:var(--stop-badge); color:var(--stop-text);
    font-weight:800; line-height:1; border:none; box-shadow:0 2px 6px rgba(0,0,0,.28);
  }
  .chip{ display:inline-flex;align-items:center;justify-content:center; min-width:48px;height:28px;padding:0 10px;border-radius:8px;font-weight:800; background:var(--chip-bg); color:var(--chip-text); border:1px solid var(--border) }
  .arrive{ display:flex;flex-direction:column;gap:2px;align-items:flex-end; font-variant-numeric:tabular-nums; font-feature-settings:"tnum" 1 }
  .eta-line{ display:flex; gap:6px; white-space:nowrap } .eta-time{ font-weight:800 } .eta-veh{ opacity:.75 } .muted{ color:var(--muted) }
  .meta{ display:flex;justify-content:space-between;gap:8px; padding:10px 12px;color:var(--muted);border-top:1px solid var(--border);font-size:12px }
  .skeleton{height:14px;width:60px;border-radius:6px;background:linear-gradient(90deg,#1d1d1d,#2a2a2a,#1d1d1d);background-size:200% 100%;animation:shim 1.1s infinite}
  body.light .skeleton{background:linear-gradient(90deg,#e9e9e9,#f4f4f4,#e9e9e9)}
  @keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* ===== Tube schematic (Info tab) ===== */
  .tube-wrap{
    padding:12px;
    display:grid;
    grid-template-columns: 1fr 280px 1fr; /* left branch | trunk | right branch */
    gap:16px;
  }
  @media (max-width: 980px){
    .tube-wrap{ grid-template-columns: 1fr; }
  }
  .tube-card{ background:var(--tube-card); border:1px solid var(--border); border-radius:14px; padding:12px; }
  .tube-title{ font-weight:800; margin:0 0 10px 0; display:flex; align-items:center; gap:8px; }
  .tube-title .arrow{ color:var(--arrow); font-size:18px; }

  /* Columns */
  .branch-col, .trunk-col{ position:relative; }
  .list{ position:relative; padding-left:26px; }
  .list::before{ content:""; position:absolute; left:13px; top:6px; bottom:6px; border-left:2px dotted var(--tube-line); }

  .stop{
    position:relative; padding:8px 8px 8px 0;
  }
  .stop::before{
    content:""; position:absolute; left:6px; top:16px; width:14px; height:14px; border-radius:50%;
    background:var(--tube-dot); box-shadow:0 0 0 3px var(--tube-card);
  }
  .name{ font-weight:700; }
  .eta{ color:var(--muted); font-size:13px; margin-top:2px; display:flex; gap:8px; flex-wrap:wrap }
  .eta strong{ color:var(--tube-dest) }

  /* Spur connector from Finchley Central */
  .spur{
    position:relative; margin-top:4px; padding-left:26px;
  }
  .spur::before{
    content:""; position:absolute; top:16px; left:13px; width:34px; border-top:2px dotted var(--tube-line);
  }
  .sr-only{
    position:absolute!important; width:1px; height:1px; padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand-stack">
      <div class="brand-row">
        <img class="logo-img" alt="SchoolRun"
             src="https://image2url.com/images/1759397137116-57468b20-63d2-4c62-95af-3ccc45c30501.png">
        <div class="appname">SchoolRun</div>
      </div>
      <nav class="menu" id="menuTabs">
        <button class="tabbtn active" data-view="morning" aria-label="School bound" title="School bound">
          <span class="icon" aria-hidden="true">â–²</span><span class="sr-only">School bound</span>
        </button>
        <button class="tabbtn" data-view="afternoon" aria-label="Home bound" title="Home bound">
          <span class="icon" aria-hidden="true">â–¼</span><span class="sr-only">Home bound</span>
        </button>
        <button class="tabbtn" data-view="info" aria-label="Northern line info" title="Northern line info">
          <span class="icon" aria-hidden="true">â“˜</span><span class="sr-only">Info</span>
        </button>
      </nav>
    </div>

    <div class="theme-ctl" aria-label="Theme">
      <label class="toggle" for="themeSwitch" title="Toggle theme (Light/Dark)">
        <input id="themeSwitch" type="checkbox" aria-label="Theme switch"/>
        <span class="mark sun">â˜€ï¸Ž</span>
        <span class="mark moon">ðŸŒ™</span>
        <span class="knob" id="knob">ðŸŒ™</span>
      </label>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="table-container" id="viewBody"></div>
      <div class="meta">
        <div>Last updated: <span id="lastUpdated">never</span></div>
        <div>Auto-refresh 10s â€¢ TfL Unified API</div>
      </div>
    </section>
  </div>

<script>
/* THEME TOGGLE */
(function(){
  const sw = document.getElementById('themeSwitch');
  const knob = document.getElementById('knob');
  const key = 'sr_theme';
  const setKnob = () => { knob.textContent = sw.checked ? 'â˜€ï¸Ž' : 'ðŸŒ™'; };
  const saved = localStorage.getItem(key);
  if(saved === 'light'){ document.body.classList.add('light'); sw.checked = true; }
  setKnob();
  sw.addEventListener('change', ()=>{
    document.body.classList.toggle('light', sw.checked);
    localStorage.setItem(key, sw.checked ? 'light' : 'dark');
    setKnob();
  });
})();

/* TfL helpers */
const APP_ID="", APP_KEY="";
const qs=o=>new URLSearchParams({...o,...((APP_ID&&APP_KEY)?{app_id:APP_ID,app_key:APP_KEY}:{})}).toString();
const tfl=async url=>{const r=await fetch(url); if(!r.ok) throw new Error('TfL'); return r.json();};
const arrivalsAt=(id,modes)=>tfl(`https://api.tfl.gov.uk/StopPoint/${encodeURIComponent(id)}/Arrivals?${qs({modes})}`);

/* ================= BUS BOARD ================= */
function matchByLine(rows,line){
  const w=String(line).toUpperCase().trim();
  return rows.filter(r=>{
    const id=String(r.lineId||'').toUpperCase().trim();
    const nm=String(r.lineName||'').toUpperCase().trim();
    return id===w||nm===w||id.startsWith(w)||nm.startsWith(w);
  });
}
const minsUntil=ts=>Math.max(0,Math.round((new Date(ts)-new Date())/60000));
function rowLineHTML(timeStr, mins, vehicleId){
  const color = mins<=2 ? 'var(--good)' : (mins<=8 ? 'var(--warn)' : 'var(--text)');
  return `<div class="eta-line" style="color:${color}">
    <span class="eta-time">${timeStr}</span>
    <span>(${mins<=0 ? 'Due' : mins+'m'})</span>
    <span class="eta-veh">â€¢ ${vehicleId||'â€”'}</span>
  </div>`;
}
const etaCache = new Map();
function smooth(key,mins){
  if(mins==null) return null;
  const prev=etaCache.get(key);
  if(prev==null){etaCache.set(key,mins);return mins;}
  const maxJump=5;
  if(Math.abs(mins-prev)>maxJump) mins = prev + Math.sign(mins-prev)*maxJump;
  const a=0.6; const sm=Math.round(a*mins+(1-a)*prev);
  etaCache.set(key,sm); return sm;
}
const routesConfig={
  morning:[
    {line:"268", origin:"Haverstock Hill", destination:"Golders Green Bus Station", stopLetter:"H",  stopId:"490003874H"},
    {line:"268", origin:"Rosslyn Hill",     destination:"Golders Green Bus Station", stopLetter:"G",  stopId:"490015255G"},
    {line:"210", origin:"Brent Cross Tesco", destination:"Golders Green Bus Station", stopLetter:"T",  stopId:"490004284T"},
    {line:"102", origin:"Claremont Way",    destination:"Golders Green Bus Station", stopLetter:"A",  stopId:"490005434S"},
    {line:"SL10",origin:"Hendon Central Station", destination:"North Finchley Bus Station", stopLetter:"A",  stopId:"490000106A"},
    {line:"13",  origin:"Golders Green",    destination:"North Finchley Bus Station", stopLetter:"GU", stopId:"490015496GU"},
    {line:"460", origin:"Golders Green",    destination:"North Finchley Bus Station", stopLetter:"GU", stopId:"490015496GU"},
  ],
  afternoon:[
    {line:"460", origin:"North Finchley Bus Station", destination:"Golders Green Bus Station", stopLetter:"P",  stopId:"490015443P"},
    {line:"13",  origin:"North Finchley Bus Station", destination:"Golders Green Bus Station", stopLetter:"P",  stopId:"490015443P"},
    {line:"SL10",origin:"North Finchley Bus Station", destination:"Hendon Central", stopLetter:"H", stopId:"490010369H"},
    {line:"268", origin:"Golders Green", destination:"Pond Street / Royal Free", stopLetter:"GJ", stopId:"490000087GJ"},
    {line:"102", origin:"Golders Green Station", destination:"Claremont Way", stopLetter:"GV", stopId:"490015496GV"},
    {line:"210", origin:"Golders Green", destination:"Brent Cross Underground", stopLetter:"GK", stopId:"490000087GK"},
  ]
};

let currentView='morning';
const viewBody=document.getElementById('viewBody');

function renderBusTable(which){
  const rows=routesConfig[which];
  const colgroup = `<colgroup>
      <col style="width:64px"><col style="width:28%"><col style="width:28%"><col style="width:10%"><col>
    </colgroup>`;
  const head=`<thead><tr>
    <th>Board</th><th>Origin</th><th>Destination</th><th>Line</th>
    <th style="text-align:right">Arrivals (next 3)</th>
  </tr></thead>`;
  const body=rows.map((r,i)=>`
    <tr>
      <td><span class="stopLetter" title="${r.stopLetter}">${r.stopLetter}</span></td>
      <td class="ell" title="${r.origin}">${r.origin}</td>
      <td class="ell" title="${r.destination}">${r.destination}</td>
      <td><span class="chip">${r.line}</span></td>
      <td style="text-align:right"><div class="arrive" id="bus-${which}-${i}">
        <span class="skeleton"></span></div>
      </td>
    </tr>`).join('');
  return `<table>${colgroup}${head}<tbody>${body}</tbody></table>`;
}

async function updateBus(which){
  const rows=routesConfig[which];
  await Promise.all(rows.map(async (r,i)=>{
    const etaEl=document.getElementById(`bus-${which}-${i}`);
    try{
      const data=await arrivalsAt(r.stopId,'bus');
      const match=matchByLine(data,r.line).sort((a,b)=>new Date(a.expectedArrival)-new Date(b.expectedArrival));
      if(!match.length){ etaEl.textContent='â€”'; etaEl.classList.add('muted'); return; }
      const html = match.slice(0,3).map((m,idx)=>{
        let mins = minsUntil(m.expectedArrival);
        if(idx===0) mins = smooth(`${which}:${i}`, mins);
        const timeStr = new Date(Date.now()+Math.max(0,mins)*60000)
                          .toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        return rowLineHTML(timeStr, mins, m.vehicleId);
      }).join('');
      etaEl.innerHTML = html;
    }catch{ etaEl.textContent='â€”'; etaEl.classList.add('muted'); }
  }));
  lastUpdated.textContent=new Date().toLocaleTimeString();
}

/* ================= Northern line schematic ================= */

/* Known StopPoint IDs (TfL) for this section */
const TFL_IDS = {
  "Camden Town":"940GZZLUCND",
  "Chalk Farm":"940GZZLUCHF",
  "Belsize Park":"940GZZLUBZP",
  "Hampstead":"940GZZLUHTD",
  "Golders Green":"940GZZLUGGN",
  "Brent Cross":"940GZZLUBTX",
  "Hendon Central":"940GZZLUHCL",
  "Colindale":"940GZZLUCNDL", /* fallback resolver will fix if off */
  "Burnt Oak":"940GZZLUBTK",
  "Edgware":"940GZZLUEGW",

  "Kentish Town":"940GZZLUKSH",
  "Tufnell Park":"940GZZLUTFP",
  "Archway":"940GZZLUACY",
  "Highgate":"940GZZLUHGT",
  "East Finchley":"940GZZLUEFY",
  "Finchley Central":"940GZZLUFYC",
  "West Finchley":"940GZZLUWFY",
  "Woodside Park":"940GZZLUWOP",
  "Totteridge & Whetstone":"940GZZLUTAW",
  "High Barnet":"940GZZLUHBT",

  "Mill Hill East":"940GZZLUMHL"
};

/* Fallback resolver if an ID above is missing/incorrect */
async function ensureStopId(name){
  if(TFL_IDS[name]) return TFL_IDS[name];
  try{
    // TfL unified search
    const url=`https://api.tfl.gov.uk/StopPoint/Search?${qs({query:name,modes:'tube',types:'NaptanMetroStation'})}`;
    const res = await tfl(url);
    const cand = (res.matches||[])[0];
    if(cand?.id){ TFL_IDS[name]=cand.id; return cand.id; }
  }catch(e){}
  return null;
}

/* Fetch next Northern prediction for a station by name */
async function tubeNextByName(name){
  const id = await ensureStopId(name);
  if(!id) return null;
  try{
    const arr = await arrivalsAt(id,'tube');
    const northern = arr.filter(a => (a.lineId||'').toLowerCase()==='northern')
                        .sort((a,b)=>new Date(a.expectedArrival)-new Date(b.expectedArrival));
    if(!northern.length) return null;
    const a = northern[0];
    return {
      mins: Math.max(0, Math.round((new Date(a.expectedArrival)-new Date())/60000)),
      time: new Date(a.expectedArrival).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
      platform: a.platformName || 'â€”',
      dest: a.destinationName || a.towards || 'â€”',
      branch: (a.destinationName||'').replace(/\s+\(.*?\)/,'').split(' via ')[0]
    };
  }catch(e){ return null; }
}

/* Build the schematic HTML */
async function renderTubeSchematic(){
  const leftBranch = [
    "Camden Town","Chalk Farm","Belsize Park","Hampstead","Golders Green",
    "Brent Cross","Hendon Central","Colindale","Burnt Oak","Edgware"
  ];
  const rightBranch = [
    "Camden Town","Kentish Town","Tufnell Park","Archway","Highgate",
    "East Finchley","Finchley Central","West Finchley","Woodside Park",
    "Totteridge & Whetstone","High Barnet"
  ];
  const spurFrom = "Finchley Central";
  const spurStop = "Mill Hill East";

  // Helper to render one list (with live next train)
  async function renderList(names){
    const items = await Promise.all(names.map(async n=>{
      const p = await tubeNextByName(n);
      const meta = p ? `
        <div class="eta">
          <span><strong>${p.time}</strong> (${p.mins<=0?'Due':p.mins+'m'})</span>
          <span>Plat <strong>${p.platform}</strong></span>
          <span>Dest <strong>${p.dest}</strong></span>
          <span>Branch <strong>${p.branch}</strong></span>
        </div>` : `<div class="eta">No prediction</div>`;
      return `<div class="stop"><div class="name">${n}</div>${meta}</div>`;
    }));
    return `<div class="list">${items.join('')}</div>`;
  }

  const leftHTML = await renderList(leftBranch);
  const rightHTML = await renderList(rightBranch);

  // Spur: show just one stop box connected to Finchley Central
  const spurPred = await tubeNextByName(spurStop);
  const spurMeta = spurPred ? `
    <div class="eta">
      <span><strong>${spurPred.time}</strong> (${spurPred.mins<=0?'Due':spurPred.mins+'m'})</span>
      <span>Plat <strong>${spurPred.platform}</strong></span>
      <span>Dest <strong>${spurPred.dest}</strong></span>
    </div>` : `<div class="eta">No prediction</div>`;

  // Assemble three columns
  return `
    <div class="tube-wrap">
      <div class="tube-card branch-col">
        <h3 class="tube-title"><span class="arrow">â–²</span> Camden Town â†’ Edgware</h3>
        ${leftHTML}
      </div>

      <div class="tube-card trunk-col">
        <h3 class="tube-title"><span class="arrow">âŽ¯âŽ¯</span> Trunk & Spur</h3>
        <div class="list">
          <div class="stop"><div class="name">Camden Town</div></div>
          <div class="stop"><div class="name">Interchange to branches</div></div>
          <div class="stop"><div class="name">Finchley Central (junction)</div></div>
          <div class="spur">
            <div class="stop"><div class="name">Mill Hill East</div>${spurMeta}</div>
          </div>
        </div>
      </div>

      <div class="tube-card branch-col">
        <h3 class="tube-title"><span class="arrow">â–²</span> Camden Town â†’ High Barnet</h3>
        ${rightHTML}
      </div>
    </div>`;
}

/* Router */
async function render(){
  if(currentView==='morning' || currentView==='afternoon'){
    viewBody.innerHTML = renderBusTable(currentView);
  } else if(currentView==='info'){
    viewBody.innerHTML = `<div class="tube-wrap"><div class="tube-card"><div class="list">
      <div class="stop"><div class="name">Loading Northern lineâ€¦</div></div></div></div></div>`;
    try{
      viewBody.innerHTML = await renderTubeSchematic();
    }catch(e){
      viewBody.innerHTML = `<div class="tube-wrap"><div class="tube-card">Unable to load Northern line data.</div></div>`;
    }
  }
}

async function refresh(){
  if(currentView==='morning' || currentView==='afternoon'){
    await updateBus(currentView);
  } else if(currentView==='info'){
    try{ viewBody.innerHTML = await renderTubeSchematic(); }catch{}
  }
  lastUpdated.textContent=new Date().toLocaleTimeString();
}

/* Init + intervals */
render(); refresh();
setInterval(refresh, 10000);

/* Tabs */
document.querySelectorAll('#menuTabs .tabbtn').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    document.querySelectorAll('#menuTabs .tabbtn').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    currentView = btn.dataset.view;
    await render();
    await refresh();
  });
});
</script>
</body>
</html>
